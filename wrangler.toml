# XIV Dye Tools Community Presets API
# Cloudflare Worker Configuration

name = "xivdyetools-presets-api"
main = "src/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# Custom domain routing
routes = [
  { pattern = "api.xivdyetools.app", custom_domain = true }
]

# Development settings
[dev]
port = 8787
local_protocol = "http"

# D1 Database binding
[[d1_databases]]
binding = "DB"
database_name = "xivdyetools-presets"
database_id = "e17d68a1-5a44-4c88-b02b-07d053cbe321"

# Service binding to Discord Worker for notifications
# Enables direct Worker-to-Worker communication (avoids error 1042)
[[services]]
binding = "DISCORD_WORKER"
service = "xivdyetools-discord-worker"

# Environment variables (non-secret)
[vars]
ENVIRONMENT = "development"
API_VERSION = "v1"
CORS_ORIGIN = "http://localhost:5173"

# Production environment
[env.production]
name = "xivdyetools-presets-api"
vars = { ENVIRONMENT = "production", API_VERSION = "v1", CORS_ORIGIN = "https://xivdyetools.app", ADDITIONAL_CORS_ORIGINS = "https://xiv-colorexplorer.pages.dev,https://xivdyetools.projectgalatine.com" }

[[env.production.d1_databases]]
binding = "DB"
database_name = "xivdyetools-presets"
database_id = "e17d68a1-5a44-4c88-b02b-07d053cbe321"

[[env.production.services]]
binding = "DISCORD_WORKER"
service = "xivdyetools-discord-worker"

# Rate limiting configuration (built into worker logic)
# - Public endpoints: 100 req/min per IP
# - Bot endpoints: 50 req/min per user
# - Submit: 10 submissions per day per user

# Secrets (set via `wrangler secret put <NAME>`)
# Required:
#   BOT_API_SECRET - Shared secret for bot authentication (must match Discord worker)
#   BOT_SIGNING_SECRET - HMAC signing key for request verification (must match Discord worker)
#
# Web OAuth (shared with xivdyetools-oauth-worker):
#   JWT_SECRET - Shared JWT signing key (generate with: openssl rand -hex 32)
#
# Moderation:
#   MODERATOR_IDS - Comma-separated Discord user IDs
#   PERSPECTIVE_API_KEY - Google Perspective API key
#
# Notifications:
#   MODERATION_WEBHOOK_URL - Discord webhook URL
#   OWNER_DISCORD_ID - Bot owner Discord ID
#   DISCORD_BOT_TOKEN - For DM notifications
#
# Discord Bot Integration (for web submission notifications):
#   DISCORD_BOT_WEBHOOK_URL - Bot internal webhook URL (e.g., http://host:port)
#   INTERNAL_WEBHOOK_SECRET - Shared secret for bot webhook auth
